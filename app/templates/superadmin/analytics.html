{% extends 'superadmin/index.html' %}
{% block content %}
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; }
.page-header { padding:18px 20px; background:white; border-bottom:1px solid #e6e6e6; }
.cards { display:flex; flex-wrap:wrap; gap:16px; padding:20px; }
.card { background:white; padding:20px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.05); flex:1; min-width:220px; }
.card h3 { margin:0 0 10px 0; font-size:18px; }
.table-container { padding:20px; }
table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,0.05); margin-bottom:30px; }
th, td { padding:12px 8px; text-align:left; border-bottom:1px solid #eee; }
th { background:#f7f7f7; }
.status { padding:4px 8px; border-radius:6px; font-weight:bold; display:inline-block; color:white; }
.to-review { background:#ffc107; color:#212529; }   /* yellow */
.processing { background:#17a2b8; }                /* teal */
.for-approval { background:#0d6efd; }              /* blue */
.completed { background:#198754; }                /* green */
.delayed { border: 1; font-weight: bold; }
</style>
</head>
<body>

<div class="page-header">
    <h2 style="margin:0;"> Bottleneck Analytics</h2>
    <div class="small">Identify where documents are stuck in departments</div>
</div>

<!-- Summary Cards -->
<div class="cards">
    <div class="card">
        <h3>Total Documents</h3>
        <p id="totalDocs" style="font-size:24px; font-weight:bold;"></p>
    </div>
    <div class="card">
        <h3>Delayed Documents</h3>
        <p id="delayedDocs" style="font-size:24px; font-weight:bold; color:red;"></p>
    </div>
</div>

<!-- Department Bottleneck Table -->
<div class="table-container">
    <h3>Department Bottlenecks</h3>
    <table id="deptTable">
        <thead>
            <tr>
                <th>Department</th>
                <th>Documents in Progress</th>
                <th>Avg. Time in Status (hrs)</th>
                <th>Delayed Documents</th>
            </tr>
        </thead>
        <tbody>
            <!-- Populated by JS -->
        </tbody>
    </table>
</div>

<!-- Top Delayed Documents Table -->
<div class="table-container">
    <h3>Top Delayed Statuses</h3>
    <table id="delayedTable">
        <thead>
            <tr>
                <th>Document ID</th>
                <th>Title</th>
                <th>Current Status</th>
                <th>Department</th>
                <th>Time in Status (hrs)</th>
            </tr>
        </thead>
        <tbody>
            <!-- Populated by JS -->
        </tbody>
    </table>
</div>

<script>
// Sample document data
const documents = [
    {id:"DOC-001", title:"Purchase Request", timeline:[
        {status:"To-Review", dept:"HR", start:"2025-11-10T08:00:00", end:"2025-11-10T09:00:00"},
        {status:"Processing", dept:"IT", start:"2025-11-10T09:05:00", end:"2025-11-11T11:00:00"},
        {status:"For Approval", dept:"Finance", start:"2025-11-11T11:05:00", end:"2025-11-12T15:00:00"},
        {status:"Completed", dept:"IT", start:"2025-11-12T15:10:00", end:"2025-11-12T15:30:00"}
    ]},
    {id:"DOC-002", title:"Budget Proposal", timeline:[
        {status:"To-Review", dept:"Accounting", start:"2025-11-08T08:20:00", end:"2025-11-08T09:00:00"},
        {status:"Processing", dept:"Accounting", start:"2025-11-08T09:05:00", end:"2025-11-10T12:00:00"},
        {status:"For Approval", dept:"Superadmin", start:"2025-11-10T12:05:00", end:"2025-11-12T14:00:00"}
    ]}
];

// Helper to compute hours
function diffHours(start, end){ return (new Date(end)-new Date(start))/1000/3600; }

// Summary
const totalDocs = documents.length;
let delayedDocsCount = 0;

// Department stats
const deptStats = {};

const delayedRows = [];

documents.forEach(doc=>{
    const lastStep = doc.timeline[doc.timeline.length-1];
    doc.timeline.forEach(step=>{
        const hrs = diffHours(step.start, step.end);

        // Dept stats
        if(!deptStats[step.dept]) deptStats[step.dept]={count:0,totalHrs:0,delayed:0};
        deptStats[step.dept].count++;
        deptStats[step.dept].totalHrs += hrs;

        // Delayed docs (>24hrs in a status)
        if(hrs>24){
            deptStats[step.dept].delayed++;
            delayedDocsCount++;
            delayedRows.push({id:doc.id,title:doc.title,status:step.status,dept:step.dept,time:hrs.toFixed(2)});
        }
    });
});

// Update summary cards
document.getElementById("totalDocs").textContent = totalDocs;
document.getElementById("delayedDocs").textContent = delayedDocsCount;

// Populate department table
const deptTbody = document.getElementById("deptTable").querySelector("tbody");
Object.keys(deptStats).forEach(dept=>{
    const d = deptStats[dept];
    const avgTime = (d.totalHrs/d.count).toFixed(2);
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${dept}</td>
                    <td>${d.count}</td>
                    <td>${avgTime}</td>
                    <td>${d.delayed}</td>`;
    deptTbody.appendChild(tr);
});

// Populate delayed documents table
const delayedTbody = document.getElementById("delayedTable").querySelector("tbody");
delayedRows.forEach(row=>{
    const tr = document.createElement("tr");
    const statusClass = row.status.toLowerCase().replace(/\s/g,'-');
    tr.innerHTML = `<td>${row.id}</td>
                    <td>${row.title}</td>
                    <td class="status ${statusClass} delayed">${row.status}</td>
                    <td>${row.dept}</td>
                    <td>${row.time}</td>`;
    delayedTbody.appendChild(tr);
});
</script>
{% endblock %}