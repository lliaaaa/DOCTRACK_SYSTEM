{% extends 'index.html' %}
{% block content %}

<style>
    .content {
        padding: 20px;
        background: #f4f4f4;
        min-height: 100vh;
    }

    .table-container {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
    }
    .btn i {
    font-size: 1rem;
}
.btn {
    margin: 0 2px;
}

</style>

<div class="content">
    <h1 class="mb-1">Users Management</h1>
    <p class="text-muted mb-4">Manage system users</p>

    <!-- Add User Button -->
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addUserModal">
            + Add User
        </button>
    </div>

    <!-- USERS TABLE -->
    <div class="table-container">
        <table class="table table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Department</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.full_name }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.role }}</td>
                    <td>{{ user.department or '-' }}</td>
                    <td>
                        {% if user.is_active %}
                        <span class="badge bg-success">Active</span>
                        {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                        {% endif %}
                    </td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td class="text-center">

                        {% if user.role != 'admin' %}

                        <!-- EDIT -->
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#editUserModal{{ user.id }}" title="Edit">
                            Edit
                        </button>

                        <!-- ACTIVATE / DEACTIVATE -->
                        <form method="POST"
                            action="{{ url_for('main.toggle_user', id=user.id) }}"
                            class="d-inline">

                            {% if not user.is_deactivated %}
                                <!-- ACTIVE → SHOW DEACTIVATE -->
                                <button class="btn btn-sm btn-outline-warning" title="Deactivate">
                                    Deactivate
                                </button>
                            {% else %}
                                <!-- DEACTIVATED → SHOW ACTIVATE -->
                                <button class="btn btn-sm btn-outline-success" title="Activate">
                                    Activate
                                </button>
                            {% endif %}
                        </form>


                        <!-- DELETE -->
                        <form method="POST" action="{{ url_for('main.delete_user', id=user.id) }}" class="d-inline"
                            onsubmit="return confirm('Delete this user?')">
                            <button class="btn btn-sm btn-outline-danger" title="Delete">
                                Delete
                            </button>
                        </form>

                        {% else %}
                        <span class="text-muted">Protected</span>
                        {% endif %}


                    </td>
                </tr>

                <!-- EDIT USER MODAL -->
                <div class="modal fade" id="editUserModal{{ user.id }}" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <form method="POST" action="{{ url_for('main.edit_user', id=user.id) }}">
                                <div class="modal-header">
                                    <h5 class="modal-title">Edit User</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" name="full_name" class="form-control"
                                            value="{{ user.full_name }}" required>
                                    </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        Cancel
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('main.add_user') }}">
                <input type="hidden" name="role" value="user">
                
                <!-- Automatically assign department -->
                <input type="hidden" name="department" value="{{ current_user.department }}">

                <div class="modal-header">
                    <h5 class="modal-title">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" name="full_name" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" name="password" class="form-control" required>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-danger" type="submit">Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}