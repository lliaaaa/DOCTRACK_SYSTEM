{% extends 'index.html' %}
{% block content %}
<style>
/* --- CONTENT --- */
.content {
    margin-left: 140px;
    padding: 20px;
    transition: 0.3s;
    background: #f4f4f4;
    font-family: Arial, sans-serif;
}
.content.collapsed { margin-left: 70px; }

/* --- TABLE --- */
.table-striped th, .table-striped td { vertical-align: middle; }
.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    color: #333;
    background-color: #ffc10740;
    border: 1px solid #ffc107;
}

/* --- NOTIFICATION BELL --- */
#notificationBell {
    position: fixed;
    bottom: 90px;
    right: 170px;
    cursor: pointer;
    font-size: 28px;
    color: #cd0808;
}
#notificationBell:hover { color: #0056b3; }
#notificationCount {
    position: absolute;
    top: -8px;
    right: -8px;
    background: red;
    color: white;
    font-size: 25px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    text-align: center;
    line-height: 20px;
    font-weight: bold;
}

/* --- MODALS --- */
.modal-body label { font-weight: 600; }

/* --- NOTIFICATION MODAL ITEMS --- */
.notification-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    position: relative;
}
.notification-item:last-child { border-bottom: none; }
.notification-item button {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
}

/* --- TABLE STYLING --- */
table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
th, td {
    padding: 12px 10px;
    text-align: left;
    font-size: 14px;
    color: #374151;
    border-bottom: 1px solid #eee;
}
th {
    font-weight: 600;
    text-transform: uppercase;
    background-color: #f1f3f5;
    color: #495057;
}
tr:nth-child(even) { background-color: #ffffff; }
tr:nth-child(odd) { background-color: #f8f9fa; }

</style>

<div class="content">
    <h1 class="dashboard-title">Transfer & Receive Documents</h1>
    <p>Only show documents your department can transfer. Incoming transfers appear in the notification bell.</p>

    <!-- DOCUMENTS TABLE -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Doc Number</th>
                <th>Title</th>
                <th>Type</th>
                <th>Implementing Office</th>
                <th>Received By</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for record in records %}
            <tr data-doc-id="{{ record.id }}">
                <td>{{ record.document_id }}</td>
                <td>{{ record.title }}</td>
                <td>{{ record.doc_type }}</td>
                <td class="implementing-office">{{ record.implementing_office }}</td>
                                <td class="received-by">{% if record.received_by %}{{ record.received_by }}{% else %}-{% endif %}</td>

                <td class="status">{{ record.status }}</td>                
                <td>
                    {% if record.status != 'Closed' %}
                        <button class="btn btn-primary btn-sm transfer-btn" data-doc-id="{{ record.id }}" data-bs-toggle="modal" data-bs-target="#transferModal">Transfer</button>
                    {% else %}
                        <span class="badge bg-secondary">Closed</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Notification Bell -->
<div id="notificationBell" data-bs-toggle="modal" data-bs-target="#notificationModal">
    <i class="fa fa-bell"></i>
    {% if incoming_transfers|length > 0 %}
    <div id="notificationCount">{{ incoming_transfers|length }}</div>
    {% endif %}
</div>

<!-- TRANSFER MODAL -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transfer Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label>Select Department to Transfer:</label>
                <select class="form-select" id="transferDept">
                    <option value="" selected disabled>Select Department</option>
                    {% for dept in departments %}
                        {% if dept.name != current_user.department %}
                            <option value="{{ dept.name }}">{{ dept.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>

                <label class="mt-3">Select Next Status:</label>
                <select class="form-select" id="transferStatus">
                    <option value="" selected disabled>Select Status</option>
                    <option>For Signature Mayor</option>
                    <option>Request for PR</option>
                    <option>Request for PO</option>
                    <option>Request for OBR</option>
                    <option>For Signature BAC Members - BAC Office</option>
                    <option>For Accounting Staff Validation</option>
                    <option>For Processing</option>
                    <option>With Checked</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="confirmTransferBtn">Transfer</button>
            </div>
        </div>
    </div>
</div>

<!-- NOTIFICATION MODAL -->
<div class="modal fade" id="notificationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Incoming Transfers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if incoming_transfers %}
                    {% for inc in incoming_transfers %}
                    <div class="notification-item" data-history-id="{{ inc.id }}">
                        <strong>{{ inc.record.document_id }}</strong> - {{ inc.record.title }}<br>
                        From: {{ inc.from_department }} â†’ To: {{ inc.to_department }}<br>
                        Status: {{ inc.status }}<br>
                        Received By: {% if inc.record.received_by %}{{ inc.record.received_by }}{% else %}-{% endif %}
                        <button class="btn btn-success btn-sm receive-btn" data-history-id="{{ inc.id }}">Confirm</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>No incoming transfers.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDocId = null;

    // Transfer button
    document.querySelectorAll('.transfer-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentDocId = btn.dataset.docId;
            document.getElementById('transferDept').value = "";
            document.getElementById('transferStatus').value = "";
        });
    });

    document.getElementById('confirmTransferBtn').addEventListener('click', async () => {
        const toDept = document.getElementById('transferDept').value;
        const newStatus = document.getElementById('transferStatus').value;
        if(!toDept || !newStatus){ alert("Select department and status."); return; }
        if(!confirm(`Transfer document to ${toDept}?`)) return;

        try {
            const res = await fetch(`/documents/transfer/${currentDocId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({to_department: toDept, status: newStatus})
            });
            const data = await res.json();
            if(data.success){
                const row = document.querySelector(`tr[data-doc-id="${currentDocId}"]`);
                row.querySelector('.status').textContent = newStatus;
                row.querySelector('.implementing-office').textContent = toDept;
                alert(data.message);
                bootstrap.Modal.getInstance(document.getElementById('transferModal')).hide();
            } else { alert(data.error); }
        } catch(err){ console.error(err); alert("Transfer failed."); }
    });

    // Receive buttons
    document.querySelectorAll('.receive-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const historyId = btn.dataset.historyId;
            if(!confirm("Confirm receipt of this document?")) return;

            try {
                const res = await fetch(`/documents/receive/${historyId}`, { method:'POST' });
                const data = await res.json();
                if(data.success){
                    const notif = document.querySelector(`.notification-item[data-history-id="${historyId}"]`);
                    if(notif) notif.remove();

                    const row = document.querySelector(`tr[data-doc-id="${data.record_id}"]`);
                    if(row){
                        row.querySelector('.implementing-office').textContent = data.new_department;
                        row.querySelector('.status').textContent = data.status;
                        row.querySelector('.received-by').textContent = data.received_by;
                    }

                    const badge = document.getElementById('notificationCount');
                    let count = parseInt(badge.textContent) - 1;
                    badge.textContent = count > 0 ? count : '';

                    alert(data.message);
                } else { alert(data.error); }
            } catch(err){ console.error(err); alert("Failed to receive document."); }
        });
    });
});
</script>
{% endblock %}
