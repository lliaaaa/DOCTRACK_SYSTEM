{% extends 'admin/index.html' %}
{% block content %}
<!-- âœ… BOOTSTRAP 5 CSS + JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
.content {
    margin-left: 140px;
    padding: 20px;
    transition: 0.3s;
    background: #f4f4f4;
    font-family: Arial, sans-serif;
}
.content.collapsed { margin-left: 70px; }

/* CARDS */
.card-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
.card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 10px; border-top: 5px solid transparent; }
.card.total { border-top-color: #0d6efd; }
.card.pending { border-top-color: #ffc107; }
.card.completed { border-top-color: #198754; }
.card.inprogress { border-top-color: #fd7e14; }
.card h3 { margin: 0; font-size: 16px; color: #333; }
.card h1 { margin: 0; font-size: 28px; color: #b71c1c; }

/* CONTROLS */
.controls-container { display: flex; gap: 10px; margin-bottom: 20px; }
.controls-container input { padding: 6px 10px; border-radius: 4px; border: 1px solid #ccc; }

/* DOCUMENT TABLE */
.recent-documents, .document-status-breakdown { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; }
.document-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
.document-table th, .document-table td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
.document-table th { font-weight: bold; color: #555; text-transform: uppercase; }

.status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: #333; background-color: #ffc10740; border: 1px solid #ffc107; }

.action-icons i { margin-right: 8px; cursor: pointer; color: #555; }
.action-icons i:hover { color: #000; }

h1.dashboard-title { margin-bottom: 5px !important; font-size: 32px; }
.greeting-text { margin-top: 0; margin-bottom: 20px; color: #777; }
.close-icon {
    font-size: 28px; /* size of the X */
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

</style>

<div class="content" id="content">
  <h1 class="dashboard-title">Documents</h1>
  <p class="greeting-text">Documents for your department: <strong>{{ current_user.department }}</strong></p>

  <!-- Search only (no department filter) -->
  <div class="controls-container">
      <input id="searchInput" type="search" placeholder="Search documents..." oninput="renderTable()">
      <select id="filterStatus" onchange="toggleExtraDropdown(); renderTable();">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="completed">Completed</option>
        <option value="inprogress">In Progress</option>
      </select>
      <select id="filterExtraStatus" onchange="renderTable()" style="display:none;">
        <option value="">Select Specific Status</option>
        <option>Request for PR</option>
        <option>Request for PO</option>
        <option>Request for OBR</option>
        <option>For Signature BAC Members - BAC Office</option>
        <option>For Accounting Staff Validation</option>
        <option>For Processing</option>
      </select>
  </div>

  <div class="recent-documents">
    <table class="document-table">
      <thead>
        <tr>
          <th>Doc Number</th><th>Title</th><th>Type</th><th>Date</th>
          <th>Released By</th><th>Received By</th><th>Status</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for record in records %}
        <tr data-doc-id="{{ record.id }}" data-status="{{ record.status }}">
          <td>{{ record.document_id }}</td>
          <td>{{ record.title }}</td>
          <td>{{ record.doc_type }}</td>
          <td>{{ record.date_received.strftime('%Y-%m-%d') }}</td>
          <td>{{ record.released_by }}</td>
          <td>{{ record.received_by }}</td>
          <td>{{ record.status }}</td>
          <td class="action-icons">
              {% if record.status != 'Closed' %}
              <button class="btn btn-link p-0 m-0 close-btn" data-id="{{ record.id }}" title="Close Document">
                  <i class="fa fa-times close-icon text-danger"></i>
              </button>
              {% else %}
              <span class="badge bg-secondary">Closed</span>
              {% endif %}
          </td>

        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
// Filters
function toggleExtraDropdown() {
    const status = document.getElementById('filterStatus').value;
    const extraDropdown = document.getElementById('filterExtraStatus');
    if (status === 'inprogress') {
        extraDropdown.style.display = 'inline-block';
    } else {
        extraDropdown.style.display = 'none';
        extraDropdown.value = '';
    }
}

function renderTable() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const statusValue = document.getElementById('filterStatus').value;
    const extraStatusValue = document.getElementById('filterExtraStatus').value.toLowerCase();
    const table = document.querySelector('.document-table tbody');
    const rows = table.getElementsByTagName('tr');

    const inProgressStatuses = [
        'request for pr','request for po','request for obr',
        'for signature bac members - bac office','for accounting staff validation','for processing'
    ];

    for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        const title = cells[1].textContent.toLowerCase();
        const statusText = cells[6].textContent.toLowerCase();

        let matchesStatus = true;
        if (statusValue === 'pending') matchesStatus = statusText.includes('for signature mayor');
        else if (statusValue === 'completed') matchesStatus = statusText.includes('with checked');
        else if (statusValue === 'inprogress') {
            matchesStatus = inProgressStatuses.some(s => statusText.includes(s));
            if (extraStatusValue) matchesStatus = statusText.includes(extraStatusValue);
        }

        const matchesSearch = title.includes(searchValue) || cells[0].textContent.toLowerCase().includes(searchValue);

        row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
    }
}

// Close document action
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const docId = this.dataset.id;

            if(!confirm("Are you sure you want to close this document?")) return;

            try {
                const res = await fetch(`/documents/close/${docId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                        // Add 'X-CSRFToken': csrf_token if CSRF protection is enabled
                    }
                });

                const data = await res.json();

                if(data.success){
                    // Replace action column with "Closed" badge
                    const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
                    if(row){
                        const actionCell = row.querySelector('td.action-icons');
                        actionCell.innerHTML = '<span class="badge bg-secondary">Closed</span>';
                        
                        // Optional: also update status cell
                        row.querySelector('td:nth-child(7)').textContent = 'Closed';
                    }

                    alert(data.message);
                } else {
                    alert(data.error || 'Failed to close document.');
                }

            } catch(err){
                console.error(err);
                alert('Network error. Could not close document.');
            }
        });
    });
});
</script>
{% endblock %}
